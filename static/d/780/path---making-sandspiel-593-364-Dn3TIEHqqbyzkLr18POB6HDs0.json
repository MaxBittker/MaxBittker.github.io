{"data":{"site":{"siteMetadata":{"title":"max-bittker"}},"markdownRemark":{"id":"28f9aede-9142-5338-9054-c60a0fde7350","html":"<p><a href=\"sandspiel.club\">Sandspiel</a> is a falling sand game I built in the fall of 2018.</p>\n<p>If you haven’t played a falling sand game before, imagine a virtual chemistry kit. You’re given a painting palette of pixelated solids, liquids, and gasses, and it’s up to you to combine them in interesting ways and discover how they interact.\n<img src=\"https://raw.githubusercontent.com/MaxBittker/sandspiel/master/Screenshot.png\" alt=\"screenshot\">\nI think I loved them so much becuase their mode of play was creative in a way that captured my imagination. Playing with the elements means asking questions, building experiments, and inventing your own games.</p>\n<p>What does “fungus” do?\nLet’s make the coolest volcano!\nCan I build a working toilet?\nDoes anything destroy lava?\nWhat happens if I do <em>this</em>?</p>\n<p>Falling sand games as a system: emergent behavior (element interactions)\nemergent behavior: social community, microculture.</p>\n<p>Three archetypes I remember fondly:</p>\n<p>Empty promises of some reward for voting.</p>\n<p>Don’t Smoke educational demonstrations.</p>\n<p>Cool volcanos.</p>\n<p>Beautiful pixel-art architecture to destroy.</p>\n<p>I built this game twice in the past. My first attempt was in pure naive javascript,\nthe second was in lua using the love2d framework.</p>\n<p>Implementing one idea multiple ways really benefited my ability to make better tradeoffs, structure a codebase that I want to work in, and avoid pitfalls. I would strongly recommend the experience to anyone!</p>\n<p>It also made building in rust and lua easier because I had a strong idea of what my datastructures would be and what types of apis I would need to use.</p>\n<p>Archetecture:</p>\n<p>Rust Universe Class</p>\n<p>Data format</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre class=\"language-rust\"><code class=\"language-rust\"><span class=\"token attribute attr-name\">#[repr(C)]</span>\n<span class=\"token keyword\">pub</span> <span class=\"token keyword\">struct</span> Cell <span class=\"token punctuation\">{</span>\n    species<span class=\"token punctuation\">:</span> Species<span class=\"token punctuation\">,</span>\n    ra<span class=\"token punctuation\">:</span> u8<span class=\"token punctuation\">,</span>\n    rb<span class=\"token punctuation\">:</span> u8<span class=\"token punctuation\">,</span>\n    clock<span class=\"token punctuation\">:</span> u8<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>for the “logic” code in species.rs that defines how elements behave, i felt able to do whatever I wanted, including lots of branching, some higher order functions, abstractions, casting type of numbers, etc. (but, definitely very little heap allocation). This is notable because language expressiveness here indirectly impacts how fun the game is, but this code is also super hot and runs thousands of times per frame.</p>\n<p>an interesting anecdote here is that I unwittingly wrote most of the game with my rustc optimization strategy on “z”, optimize for binary size. once the project was already quite developed I realized this and switched it to o3 which things like inlining and gave me a big performance boost, where i had been being frugal!</p>\n<p>JS UI\nI threw this together in React. If you have one takeaway from this project, i want it to be that Web Assembly is not an all or nothing thing! The ability to put performance and low-level critical logic into Rust and write glue code, browser api, and UX code in JS and JSX was really critical to this project working out. I was able to leverage the npm ecosytsem for great tools like React, Regl, and GLSLify, as well as for the flexibility to throw data back and forth via global variables and closures and JSON blobs without planning or needing to refactor in order to validate ideas. Nothing I wrote in JS would have been impossible to accomplish in rust, but it wouldn’t have come together as well as it did on the timeframe it did.</p>\n<p>Building high quality interfaces with React is something I value and respect (it’s not easy!), but I really phoned it in for this part of the codebase. The experience suffers for it, there are a lot of small UI touches like loading indicators, propper routing, buttons with no visual feedback, but I was really itching to release the game and didn’t want to put the work into refactoring or cludging even more behavior into my one component.</p>\n<p>Fluid Dynamics</p>\n<p>Adapting this code was the most difficult technical challenge of the project, because i had huge\nThe texture types they support (the fluid sim is in floats, but on phone browsers I could only take data in or out of the shaders via unsigned byte textures, required some munging)</p>\n<p>There’s also a maximum # of bound texture units of 8, and I had to plug a lot of gaps in my knowledge of how OpenGL works in order to correctly bind textures for each program and stay under that limit.</p>\n<p>all of this was made more complicated by the fact my only phone is an iphone and I don’t own a macbook. Apple only allows you to connect to the safari devtools from a mac >:’( So i was debugging somewhat blind.</p>\n<p>Firebase\nI wanted to avoid having accounts and cookies and junk\nserializeing state worked really well\nVote counters\nIP adddresses\nFirebase cloud functions worked really well to handle demand (average 2 requests per second on the peak day)</p>\n<p>There were times when I was <em>really</em> just wished I was writing a http server with a redis instance and dumping the files into a directory. But I don’t want to be on the hook for DDos, failovers, upgrading dependencies - especially when the other things running on my VPS are already fragile, stateful, and ad-hoc. This was less fun to write and to debug but I don’t have to think about it and it’s really cheap. I’ve spent about $30 of my free credits, and I expect that at the current (low) rate of traffic, it will be sustainable for me to keep running for the forseable future.</p>\n<h3>Javascript:</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> cellsData <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Uint8Array</span><span class=\"token punctuation\">(</span>\n  memory<span class=\"token punctuation\">.</span>buffer<span class=\"token punctuation\">,</span>\n  universe<span class=\"token punctuation\">.</span><span class=\"token function\">cells</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  width <span class=\"token operator\">*</span> height <span class=\"token operator\">*</span> <span class=\"token number\">4</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ngl<span class=\"token punctuation\">.</span><span class=\"token function\">bindTexture</span><span class=\"token punctuation\">(</span>gl<span class=\"token punctuation\">.</span><span class=\"token constant\">TEXTURE_2D</span><span class=\"token punctuation\">,</span> cells<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ngl<span class=\"token punctuation\">.</span><span class=\"token function\">texImage2D</span><span class=\"token punctuation\">(</span>\n  gl<span class=\"token punctuation\">.</span><span class=\"token constant\">TEXTURE_2D</span><span class=\"token punctuation\">,</span>\n  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  gl<span class=\"token punctuation\">.</span><span class=\"token constant\">RGBA</span><span class=\"token punctuation\">,</span>\n  width<span class=\"token punctuation\">,</span>\n  height<span class=\"token punctuation\">,</span>\n  <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n  gl<span class=\"token punctuation\">.</span><span class=\"token constant\">RGBA</span><span class=\"token punctuation\">,</span>\n  gl<span class=\"token punctuation\">.</span><span class=\"token constant\">UNSIGNED_BYTE</span><span class=\"token punctuation\">,</span>\n  cellsData\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Thanks to Chris Crawford, Nikhilesh Sigatapu, Thais Correia, Pavel Dobryakov, the Rust WebAssembly working group, and ha55ii for inspiration, knowledge, code, and feedback!</p>","frontmatter":{"title":"Making Sandspiel","date":"January 06, 2019"}}},"pageContext":{"slug":"/making-sandspiel/","previous":{"fields":{"slug":"/code-review/"},"frontmatter":{"title":"How to Review Code You Don't Understand"}},"next":{"fields":{"slug":"/post1/"},"frontmatter":{"title":"Thinking about Color (WIP)"}}}}